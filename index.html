<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Top bar -->
  <div class="flex justify-between items-center p-4">
    <div class="space-x-2">
      <button onclick="setLanguage('en')" class="px-3 py-1 bg-blue-600 rounded">EN</button>
      <button onclick="setLanguage('si')" class="px-3 py-1 bg-green-600 rounded">සිං</button>
      <button onclick="setLanguage('ta')" class="px-3 py-1 bg-pink-600 rounded">தமிழ்</button>
    </div>
    <div>
      <button id="ownerLoginBtn" onclick="showOwnerLogin()" class="px-4 py-2 bg-gray-700 rounded">
        🔐 <span data-i18n="ownerAccess">Owner Access</span>
      </button>
      <button id="downloadBtn" onclick="downloadSubmissions()" class="hidden px-4 py-2 bg-purple-600 rounded ml-2">
        💾 Download JSON
      </button>
      <button id="downloadPdfBtn" onclick="downloadPDF()" class="hidden px-4 py-2 bg-yellow-600 rounded ml-2">
        📕 Download PDF
      </button>
      <button id="clearDataBtn" onclick="clearData()" class="hidden px-4 py-2 bg-red-700 rounded ml-2">
        🗑️ Clear Data
      </button>
      <button id="logoutBtn" onclick="logoutOwner()" class="hidden px-4 py-2 bg-red-600 rounded ml-2">
        🚪 Logout
      </button>
    </div>
  </div>

  <!-- Main -->
  <div class="flex flex-col items-center justify-center">
    <h1 data-i18n="title" class="text-5xl font-bold my-6">Member Management System</h1>
    <button onclick="openForm()" class="px-6 py-3 bg-blue-600 rounded-lg">➕ Add New Member</button>
  </div>

  <!-- Status messages -->
  <div id="statusDisplay" class="hidden text-center mt-4 p-3 rounded-xl"></div>

  <!-- Owner Login Modal -->
  <div id="ownerModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center">
    <div class="bg-gray-800 rounded-xl p-6 w-96 relative">
      <button onclick="closeOwnerLogin()" class="absolute top-3 right-3 text-xl">&times;</button>
      <h2 class="text-2xl mb-4">Owner Access</h2>
      <form id="ownerForm" class="space-y-4">
        <input type="password" id="ownerPassword" placeholder="Enter password" class="w-full p-2 rounded bg-gray-700 border border-gray-500">
        <button type="submit" class="w-full py-2 bg-blue-600 rounded">Unlock</button>
      </form>
    </div>
  </div>

  <!-- Add Member Modal -->
  <div id="formModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg relative">
      <button onclick="closeForm()" class="absolute top-3 right-3 text-xl">&times;</button>
      <h2 class="text-2xl mb-4">Add Member</h2>
      <form id="memberForm" class="space-y-4">
        <input type="text" id="name" placeholder="Full Name" required class="w-full p-2 rounded bg-gray-700 border border-gray-500">
        <input type="date" id="birthday" required class="w-full p-2 rounded bg-gray-700 border border-gray-500">
        <select id="sex" required class="w-full p-2 rounded bg-gray-700 border border-gray-500">
          <option value="">-- Select Sex --</option>
          <option value="Male">Male ♂️</option>
          <option value="Female">Female ♀️</option>
          <option value="Other">Other ⚧️</option>
        </select>
        <textarea id="familyMembers" placeholder="Family Members (Name - Relation)" class="w-full p-2 rounded bg-gray-700 border border-gray-500"></textarea>
        <button type="submit" class="w-full py-2 bg-green-600 rounded">💾 Save</button>
      </form>
    </div>
  </div>

  <!-- Members Table (Owner only) -->
  <div id="memberTableSection" class="hidden p-6">
    <h2 class="text-3xl mb-4">All Members</h2>
    <table class="w-full border border-gray-600 text-left">
      <thead class="bg-gray-700">
        <tr>
          <th class="p-2">Name</th>
          <th class="p-2">Birthday</th>
          <th class="p-2">Sex</th>
          <th class="p-2">Family</th>
          <th class="p-2">Time</th>
        </tr>
      </thead>
      <tbody id="memberTableBody" class="divide-y divide-gray-600"></tbody>
    </table>
  </div>

<script>
  // ✅ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyANUfgVwR0uWPOaFzf1GrehpfitR1sUGw0",
    authDomain: "project01-d5df2.firebaseapp.com",
    projectId: "project01-d5df2",
    storageBucket: "project01-d5df2.firebasestorage.app",
    messagingSenderId: "398259647179",
    appId: "1:398259647179:web:54c78c2144a5d70e58614e",
    measurementId: "G-Q1ZVC5C7LZ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let isOwner = false;
  const OWNER_PASSWORD = "Hasintha15$"; // 🔑 Change this to your own

  // 🔹 Add member to Firestore
  document.getElementById("memberForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const data = {
      name: document.getElementById("name").value,
      birthday: document.getElementById("birthday").value,
      sex: document.getElementById("sex").value,
      family: document.getElementById("familyMembers").value,
      timestamp: new Date().toISOString()
    };
    try {
      await db.collection("members").add(data);
      showStatus(`✅ Member "${data.name}" saved!`);
      document.getElementById("memberForm").reset();
      closeForm();
    } catch (err) {
      showStatus("❌ Error saving data: " + err.message, false);
    }
  });

  // 🔹 Owner Login
  document.getElementById("ownerForm").addEventListener("submit", (e) => {
    e.preventDefault();
    const pass = document.getElementById("ownerPassword").value;
    if (pass === OWNER_PASSWORD) {
      isOwner = true;
      showOwnerFeatures();
      closeOwnerLogin();
      loadMembers();
      showStatus("🔓 Owner Access Granted!");
    } else {
      showStatus("❌ Wrong password!", false);
    }
  });

  // 🔹 Load members into table (real-time)
  function loadMembers() {
    db.collection("members").orderBy("timestamp", "desc")
      .onSnapshot(snapshot => {
        const tbody = document.getElementById("memberTableBody");
        tbody.innerHTML = "";
        snapshot.forEach(doc => {
          const m = doc.data();
          tbody.innerHTML += `
            <tr>
              <td class="p-2">${m.name}</td>
              <td class="p-2">${m.birthday}</td>
              <td class="p-2">${m.sex}</td>
              <td class="p-2 whitespace-pre-line">${m.family || ""}</td>
              <td class="p-2">${new Date(m.timestamp).toLocaleString()}</td>
            </tr>`;
        });
      });
  }

  // 🔹 Show & Hide UI
  function showOwnerFeatures() {
    document.getElementById("ownerLoginBtn").classList.add("hidden");
    document.getElementById("downloadBtn").classList.remove("hidden");
    document.getElementById("downloadPdfBtn").classList.remove("hidden");
    document.getElementById("clearDataBtn").classList.remove("hidden");
    document.getElementById("logoutBtn").classList.remove("hidden");
    document.getElementById("memberTableSection").classList.remove("hidden");
  }
  function logoutOwner() {
    isOwner = false;
    document.getElementById("ownerLoginBtn").classList.remove("hidden");
    document.getElementById("downloadBtn").classList.add("hidden");
    document.getElementById("downloadPdfBtn").classList.add("hidden");
    document.getElementById("clearDataBtn").classList.add("hidden");
    document.getElementById("logoutBtn").classList.add("hidden");
    document.getElementById("memberTableSection").classList.add("hidden");
    showStatus("🔒 Owner Logged Out.");
  }

  // 🔹 PDF Download
  function downloadPDF() {
    db.collection("members").get().then(snapshot => {
      let { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Member Records", 10, 10);
      let y = 20;
      snapshot.forEach(d => {
        let m = d.data();
        doc.text(`${m.name} | ${m.birthday} | ${m.sex}`, 10, y);
        y += 10;
      });
      doc.save("members.pdf");
    });
  }

  // 🔹 JSON Download
  function downloadSubmissions() {
    db.collection("members").get().then(snapshot => {
      let members = [];
      snapshot.forEach(doc => members.push(doc.data()));
      const blob = new Blob([JSON.stringify(members, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "members.json";
      a.click();
    });
  }

  // 🔹 Clear Data
  async function clearData() {
    if (!confirm("⚠️ Delete all data?")) return;
    const snap = await db.collection("members").get();
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    showStatus("🗑️ All members deleted.");
  }

  // 🔹 UI Helpers
  function showStatus(msg, ok = true) {
    const div = document.getElementById("statusDisplay");
    div.textContent = msg;
    div.className = `mt-4 p-3 rounded ${ok ? 'bg-green-600' : 'bg-red-600'}`;
    div.classList.remove("hidden");
    setTimeout(() => div.classList.add("hidden"), 4000);
  }
  function openForm(){ document.getElementById("formModal").classList.remove("hidden"); }
  function closeForm(){ document.getElementById("formModal").classList.add("hidden"); }
  function showOwnerLogin(){ document.getElementById("ownerModal").classList.remove("hidden"); }
  function closeOwnerLogin(){ document.getElementById("ownerModal").classList.add("hidden"); }
</script>
</body>
</html>
