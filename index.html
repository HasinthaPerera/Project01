<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

  <!-- Navbar -->
  <div class="flex justify-between items-center p-4">
    <div class="space-x-2">
      <button onclick="setLanguage('en')" class="px-3 py-1 bg-blue-600 rounded">EN</button>
      <button onclick="setLanguage('si')" class="px-3 py-1 bg-green-600 rounded">සිං</button>
      <button onclick="setLanguage('ta')" class="px-3 py-1 bg-pink-600 rounded">தமிழ்</button>
    </div>
    <div>
      <button id="ownerLoginBtn" onclick="showOwnerLogin()" class="px-4 py-2 bg-gray-700 rounded">🔐 Owner Access</button>
      <button id="logoutBtn" onclick="logoutOwner()" class="hidden px-4 py-2 bg-red-600 rounded ml-2">🚪 Logout</button>
    </div>
  </div>

  <!-- Main -->
  <div class="flex flex-col items-center justify-center">
    <h1 data-i18n="title" class="text-5xl font-bold my-6 text-purple-400">Member Management System</h1>
    <button onclick="openForm()" class="px-6 py-3 bg-blue-600 rounded-lg text-xl">➕ Add New Member</button>
    <button onclick="loadMembers()" class="mt-4 px-6 py-3 bg-green-600 rounded-lg text-xl">📋 View All Members</button>
    
    <!-- Terms PDFs -->
    <div class="flex space-x-4 mt-6">
      <a href="terms1.pdf" target="_blank" class="px-4 py-2 bg-purple-600 rounded">📜 Committee Terms (Part 1)</a>
      <a href="terms2.pdf" target="_blank" class="px-4 py-2 bg-teal-600 rounded">📜 Committee Terms (Part 2)</a>
      <a href="terms3.pdf" target="_blank" class="px-4 py-2 bg-red-600 rounded">📜 Committee Terms (Part 3)</a>
    </div>
  </div>

  <!-- Status -->
  <div id="status" class="text-center mt-6 text-lg"></div>

  <!-- Members Table -->
  <div id="membersTable" class="hidden p-6">
    <h2 class="text-2xl mb-4">📋 Members List</h2>
    <table class="table-auto w-full border border-gray-500">
      <thead>
        <tr class="bg-gray-800">
          <th class="px-4 py-2">Name</th>
          <th class="px-4 py-2">Birthday</th>
          <th class="px-4 py-2">Sex</th>
          <th class="px-4 py-2">Family</th>
          <th class="px-4 py-2">Actions</th>
        </tr>
      </thead>
      <tbody id="membersBody" class="text-center"></tbody>
    </table>
    <div id="ownerTools" class="hidden mt-4">
      <button onclick="downloadJSON()" class="px-4 py-2 bg-purple-600 rounded">💾 Download JSON</button>
      <button onclick="downloadPDF()" class="px-4 py-2 bg-yellow-600 rounded ml-2">📕 Download PDF</button>
    </div>
  </div>

  <!-- Add Member Form Modal -->
  <div id="formModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-96">
      <h2 class="text-2xl mb-4">Add Member</h2>
      <form id="memberForm" class="space-y-4">
        <input type="text" id="name" placeholder="Name" required class="w-full p-2 rounded bg-gray-700">
        <input type="date" id="birthday" required class="w-full p-2 rounded bg-gray-700">
        <select id="sex" required class="w-full p-2 rounded bg-gray-700">
          <option value="">Select Sex</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
        <textarea id="family" placeholder="Family Members" class="w-full p-2 rounded bg-gray-700"></textarea>
        <button type="submit" class="w-full py-2 bg-blue-600 rounded">Save</button>
      </form>
      <button onclick="closeForm()" class="mt-4 px-4 py-2 bg-red-600 rounded">Close</button>
    </div>
  </div>

  <!-- Owner Login Modal -->
  <div id="ownerModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center">
    <div class="bg-gray-800 p-6 rounded-lg w-96">
      <h2 class="text-2xl mb-4">Owner Login</h2>
      <form id="ownerForm" class="space-y-4">
        <input type="email" id="ownerEmail" placeholder="Email" required class="w-full p-2 rounded bg-gray-700">
        <input type="password" id="ownerPassword" placeholder="Password" required class="w-full p-2 rounded bg-gray-700">
        <button type="submit" class="w-full py-2 bg-green-600 rounded">Unlock</button>
      </form>
      <button onclick="closeOwnerLogin()" class="mt-4 px-4 py-2 bg-red-600 rounded">Close</button>
    </div>
  </div>

  <script>
    // 🌍 Multi-language translations
    const translations = {
      en: { title: "Member Management System" },
      si: { title: "සාමාජික කළමනාකරණ පද්ධතිය" },
      ta: { title: "உறுப்பினர் மேலாண்மை அமைப்பு" }
    };
    function setLanguage(lang) {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        el.textContent = translations[lang][key] || el.textContent;
      });
    }

    // 🔑 Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyANUfgVwR0uWPOaFzf1GrehpfitR1sUGw0",
      authDomain: "project01-d5df2.firebaseapp.com",
      projectId: "project01-d5df2",
      storageBucket: "project01-d5df2.firebasestorage.app",
      messagingSenderId: "398259647179",
      appId: "1:398259647179:web:54c78c2144a5d70e58614e",
      measurementId: "G-Q1ZVC5C7LZ"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let isOwner = false;

    // Show/hide modals
    function openForm(){ document.getElementById("formModal").classList.remove("hidden"); }
    function closeForm(){ document.getElementById("formModal").classList.add("hidden"); }
    function showOwnerLogin(){ document.getElementById("ownerModal").classList.remove("hidden"); }
    function closeOwnerLogin(){ document.getElementById("ownerModal").classList.add("hidden"); }

    function showStatus(msg, success=true){
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = success ? "text-green-400 mt-6" : "text-red-400 mt-6";
    }

    // Add member (anyone can do this)
    document.getElementById("memberForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const formData = {
        name: document.getElementById("name").value,
        birthday: document.getElementById("birthday").value,
        sex: document.getElementById("sex").value,
        family: document.getElementById("family").value
      };
      try {
        await db.collection("members").add(formData);
        showStatus("✅ Member saved!");
        closeForm();
      } catch(err){ showStatus("❌ Error: "+err.message,false); }
    });

    // Load members (anyone can view)
    async function loadMembers(){
      const table = document.getElementById("membersTable");
      const body = document.getElementById("membersBody");
      body.innerHTML = "";
      try {
        const snapshot = await db.collection("members").get();
        snapshot.forEach(doc=>{
          const m = doc.data();
          body.innerHTML += `
            <tr>
              <td>${m.name}</td>
              <td>${m.birthday}</td>
              <td>${m.sex}</td>
              <td>${m.family}</td>
              <td>${isOwner ? `<button onclick="deleteMember('${doc.id}')" class='bg-red-600 px-2 rounded'>❌ Delete</button>` : "-"}</td>
            </tr>`;
        });
        table.classList.remove("hidden");
        if(isOwner) document.getElementById("ownerTools").classList.remove("hidden");
      }catch(err){ showStatus("❌ "+err.message,false); }
    }

    // Owner Login
    document.getElementById("ownerForm").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = document.getElementById("ownerEmail").value;
      const pass = document.getElementById("ownerPassword").value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        isOwner = true;
        showStatus("🔓 Owner Access Granted!");
        document.getElementById("ownerLoginBtn").classList.add("hidden");
        document.getElementById("logoutBtn").classList.remove("hidden");
        closeOwnerLogin();
        loadMembers(); // reload with delete buttons
      }catch(err){ showStatus("❌ Login failed: "+err.message,false); }
    });

    function logoutOwner(){
      auth.signOut().then(()=>{
        isOwner = false;
        showStatus("🔒 Owner Logged Out");
        document.getElementById("ownerLoginBtn").classList.remove("hidden");
        document.getElementById("logoutBtn").classList.add("hidden");
        document.getElementById("ownerTools").classList.add("hidden");
        loadMembers(); // reload without delete buttons
      });
    }

    // Delete member (owner only)
    async function deleteMember(id){
      if(!isOwner) return;
      await db.collection("members").doc(id).delete();
      showStatus("🗑️ Member deleted");
      loadMembers();
    }

    // Download JSON
    async function downloadJSON(){
      const snapshot = await db.collection("members").get();
      const data = snapshot.docs.map(doc=>doc.data());
      const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "members.json";
      a.click();
    }

    // Download PDF
    async function downloadPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      const snapshot = await db.collection("members").get();
      snapshot.forEach(d=>{
        const m = d.data();
        doc.text(`Name: ${m.name}, Birthday: ${m.birthday}, Sex: ${m.sex}, Family: ${m.family}`,10,y);
        y+=10;
      });
      doc.save("members.pdf");
    }
  </script>
</body>
</html>
